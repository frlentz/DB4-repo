from machine import Pin
from machine import ADC
from machine import DAC
from math import log

import machine
import utime

adc_V_lookup = [0.0, 0.00322581, 0.00645161, 0.00967742, 0.01290323, 0.01612903, 0.01935484, 0.02258065, 0.02580645, 0.02903226,
    0.03225806, 0.03548387, 0.03870968, 0.04193548, 0.04516129, 0.0483871, 0.0516129, 0.05483871, 0.05806452, 0.06129032,
    0.06451613, 0.06774194, 0.07096774, 0.07419355, 0.07741935, 0.08064516, 0.08387097, 0.08709677, 0.09032258, 0.09354839,
    0.09677419, 0.1, 0.10322581, 0.10645161, 0.10967742, 0.11290323, 0.11612903, 0.11935484, 0.12258065, 0.12580645,
    0.12903226, 0.13225806, 0.13548387, 0.13870968, 0.14193548, 0.14516129, 0.1483871, 0.1516129, 0.15483871, 0.15806452,
    0.16129032, 0.16451613, 0.16774194, 0.17096774, 0.17419355, 0.17741935, 0.18064516, 0.18387097, 0.18709677, 0.19032258,
    0.19354839, 0.19677419, 0.2, 0.20322581, 0.20645161, 0.20967742, 0.21290323, 0.21612903, 0.21935484, 0.22258065,
    0.22580645, 0.22903226, 0.23225806, 0.23548387, 0.23870968, 0.24193548, 0.24516129, 0.2483871, 0.2516129, 0.25483871,
    0.25806452, 0.26129032, 0.26451613, 0.26774194, 0.27096774, 0.27419355, 0.27741935, 0.28064516, 0.28387097, 0.28709677,
    0.29032258, 0.29354839, 0.29677419, 0.3, 0.30322581, 0.30645161, 0.30967742, 0.31290323, 0.31612903, 0.31935484,
    0.32258065, 0.32580645, 0.32903226, 0.33225806, 0.33548387, 0.33870968, 0.34193548, 0.34516129, 0.3483871, 0.3516129,
    0.35483871, 0.35806452, 0.36129032, 0.36451613, 0.36774194, 0.37096774, 0.37419355, 0.37741935, 0.38064516, 0.38387097,
    0.38709677, 0.39032258, 0.39354839, 0.39677419, 0.4, 0.40322581, 0.40645161, 0.40967742, 0.41290323, 0.41612903,
    0.41935484, 0.42258065, 0.42580645, 0.42903226, 0.43225806, 0.43548387, 0.43870968, 0.44193548, 0.44516129, 0.4483871,
    0.4516129, 0.45483871, 0.45806452, 0.46129032, 0.46451613, 0.46774194, 0.47096774, 0.47419355, 0.47741935, 0.48064516,
    0.48387097, 0.48709677, 0.49032258, 0.49354839, 0.49677419, 0.5, 0.50322581, 0.50645161, 0.50967742, 0.51290323,
    0.51612903, 0.51935484, 0.52258065, 0.52580645, 0.52903226, 0.53225806, 0.53548387, 0.53870968, 0.54193548, 0.54516129,
    0.5483871, 0.5516129, 0.55483871, 0.55806452, 0.56129032, 0.56451613, 0.56774194, 0.57096774, 0.57419355, 0.57741935,
    0.58064516, 0.58387097, 0.58709677, 0.59032258, 0.59354839, 0.59677419, 0.6, 0.60322581, 0.60645161, 0.60967742,
    0.61290323, 0.61612903, 0.61935484, 0.62258065, 0.62580645, 0.62903226, 0.63225806, 0.63548387, 0.63870968, 0.64193548,
    0.64516129, 0.6483871, 0.6516129, 0.65483871, 0.65806452, 0.66129032, 0.66451613, 0.66774194, 0.67096774, 0.67419355,
    0.67741935, 0.68064516, 0.68387097, 0.68709677, 0.69032258, 0.69354839, 0.69677419, 0.7, 0.70322581, 0.70645161,
    0.70967742, 0.71290323, 0.71612903, 0.71935484, 0.72258065, 0.72580645, 0.72903226, 0.73225806, 0.73548387, 0.73870968,
    0.74193548, 0.74516129, 0.7483871, 0.7516129, 0.75483871, 0.75806452, 0.76129032, 0.76451613, 0.76774194, 0.77096774,
    0.77419355, 0.77741935, 0.78064516, 0.78387097, 0.78709677, 0.79032258, 0.79354839, 0.79677419, 0.8, 0.80322581,
    0.80645161, 0.80967742, 0.81290323, 0.81612903, 0.81935484, 0.82258065, 0.82580645, 0.82903226, 0.83225806, 0.83548387,
    0.83870968, 0.84193548, 0.84516129, 0.8483871, 0.8516129, 0.85483871, 0.85806452, 0.86129032, 0.86451613, 0.86774194,
    0.87096774, 0.87419355, 0.87741935, 0.88064516, 0.88387097, 0.88709677, 0.89032258, 0.89354839, 0.89677419, 0.9,
    0.90322581, 0.90645161, 0.90967742, 0.91290323, 0.91612903, 0.91935484, 0.92258065, 0.92580645, 0.92903226, 0.93225806,
    0.93548387, 0.93870968, 0.94193548, 0.94516129, 0.9483871, 0.9516129, 0.95483871, 0.95806452, 0.96129032, 0.96451613,
    0.96774194, 0.97096774, 0.97419355, 0.97741935, 0.98064516, 0.98387097, 0.98709677, 0.99032258, 0.99354839, 0.99677419,
    1.0, 1.00322581, 1.00645161, 1.00967742, 1.01290323, 1.01612903, 1.01935484, 1.02258065, 1.02580645, 1.02903226,
    1.03225806, 1.03548387, 1.03870968, 1.04193548, 1.04516129, 1.0483871, 1.0516129, 1.05483871, 1.05806452, 1.06129032,
    1.06451613, 1.06774194, 1.07096774, 1.07419355, 1.07741935, 1.08064516, 1.08387097, 1.08709677, 1.09032258, 1.09354839,
    1.09677419, 1.1, 1.10322581, 1.10645161, 1.10967742, 1.11290323, 1.11612903, 1.11935484, 1.12258065, 1.12580645,
    1.12903226, 1.13225806, 1.13548387, 1.13870968, 1.14193548, 1.14516129, 1.1483871, 1.1516129, 1.15483871, 1.15806452,
    1.16129032, 1.16451613, 1.16774194, 1.17096774, 1.17419355, 1.17741935, 1.18064516, 1.18387097, 1.18709677, 1.19032258,
    1.19354839, 1.19677419, 1.2, 1.20322581, 1.20645161, 1.20967742, 1.21290323, 1.21612903, 1.21935484, 1.22258065,
    1.22580645, 1.22903226, 1.23225806, 1.23548387, 1.23870968, 1.24193548, 1.24516129, 1.2483871, 1.2516129, 1.25483871,
    1.25806452, 1.26129032, 1.26451613, 1.26774194, 1.27096774, 1.27419355, 1.27741935, 1.28064516, 1.28387097, 1.28709677,
    1.29032258, 1.29354839, 1.29677419, 1.3, 1.30322581, 1.30645161, 1.30967742, 1.31290323, 1.31612903, 1.31935484,
    1.32258065, 1.32580645, 1.32903226, 1.33225806, 1.33548387, 1.33870968, 1.34193548, 1.34516129, 1.3483871, 1.3516129,
    1.35483871, 1.35806452, 1.36129032, 1.36451613, 1.36774194, 1.37096774, 1.37419355, 1.37741935, 1.38064516, 1.38387097,
    1.38709677, 1.39032258, 1.39354839, 1.39677419, 1.4, 1.40322581, 1.40645161, 1.40967742, 1.41290323, 1.41612903,
    1.41935484, 1.42258065, 1.42580645, 1.42903226, 1.43225806, 1.43548387, 1.43870968, 1.44193548, 1.44516129, 1.4483871,
    1.4516129, 1.45483871, 1.45806452, 1.46129032, 1.46451613, 1.46774194, 1.47096774, 1.47419355, 1.47741935, 1.48064516,
    1.48387097, 1.48709677, 1.49032258, 1.49354839, 1.49677419, 1.5, 1.50322581, 1.50645161, 1.50967742, 1.51290323,
    1.51612903, 1.51935484, 1.52258065, 1.52580645, 1.52903226, 1.53225806, 1.53548387, 1.53870968, 1.54193548, 1.54516129,
    1.5483871, 1.5516129, 1.55483871, 1.55806452, 1.56129032, 1.56451613, 1.56774194, 1.57096774, 1.57419355, 1.57741935,
    1.58064516, 1.58387097, 1.58709677, 1.59032258, 1.59354839, 1.59677419, 1.6, 1.60322581, 1.60645161, 1.60967742,
    1.61290323, 1.61612903, 1.61935484, 1.62258065, 1.62580645, 1.62903226, 1.63225806, 1.63548387, 1.63870968, 1.64193548,
    1.64516129, 1.6483871, 1.6516129, 1.65483871, 1.65806452, 1.66129032, 1.66451613, 1.66774194, 1.67096774, 1.67419355,
    1.67741935, 1.68064516, 1.68387097, 1.68709677, 1.69032258, 1.69354839, 1.69677419, 1.7, 1.70322581, 1.70645161,
    1.70967742, 1.71290323, 1.71612903, 1.71935484, 1.72258065, 1.72580645, 1.72903226, 1.73225806, 1.73548387, 1.73870968,
    1.74193548, 1.74516129, 1.7483871, 1.7516129, 1.75483871, 1.75806452, 1.76129032, 1.76451613, 1.76774194, 1.77096774,
    1.77419355, 1.77741935, 1.78064516, 1.78387097, 1.78709677, 1.79032258, 1.79354839, 1.79677419, 1.8, 1.80322581,
    1.80645161, 1.80967742, 1.81290323, 1.81612903, 1.81935484, 1.82258065, 1.82580645, 1.82903226, 1.83225806, 1.83548387,
    1.83870968, 1.84193548, 1.84516129, 1.8483871, 1.8516129, 1.85483871, 1.85806452, 1.86129032, 1.86451613, 1.86774194,
    1.87096774, 1.87419355, 1.87741935, 1.88064516, 1.88387097, 1.88709677, 1.89032258, 1.89354839, 1.89677419, 1.9,
    1.90322581, 1.90645161, 1.90967742, 1.91290323, 1.91612903, 1.91935484, 1.92258065, 1.92580645, 1.92903226, 1.93225806,
    1.93548387, 1.93870968, 1.94193548, 1.94516129, 1.9483871, 1.9516129, 1.95483871, 1.95806452, 1.96129032, 1.96451613,
    1.96774194, 1.97096774, 1.97419355, 1.97741935, 1.98064516, 1.98387097, 1.98709677, 1.99032258, 1.99354839, 1.99677419,
    2.0, 2.00322581, 2.00645161, 2.00967742, 2.01290323, 2.01612903, 2.01935484, 2.02258065, 2.02580645, 2.02903226,
    2.03225806, 2.03548387, 2.03870968, 2.04193548, 2.04516129, 2.0483871, 2.0516129, 2.05483871, 2.05806452, 2.06129032,
    2.06451613, 2.06774194, 2.07096774, 2.07419355, 2.07741935, 2.08064516, 2.08387097, 2.08709677, 2.09032258, 2.09354839,
    2.09677419, 2.1, 2.10322581, 2.10645161, 2.10967742, 2.11290323, 2.11612903, 2.11935484, 2.12258065, 2.12580645,
    2.12903226, 2.13225806, 2.13548387, 2.13870968, 2.14193548, 2.14516129, 2.1483871, 2.1516129, 2.15483871, 2.15806452,
    2.16129032, 2.16451613, 2.16774194, 2.17096774, 2.17419355, 2.17741935, 2.18064516, 2.18387097, 2.18709677, 2.19032258,
    2.19354839, 2.19677419, 2.2, 2.20322581, 2.20645161, 2.20967742, 2.21290323, 2.21612903, 2.21935484, 2.22258065,
    2.22580645, 2.22903226, 2.23225806, 2.23548387, 2.23870968, 2.24193548, 2.24516129, 2.2483871, 2.2516129, 2.25483871,
    2.25806452, 2.26129032, 2.26451613, 2.26774194, 2.27096774, 2.27419355, 2.27741935, 2.28064516, 2.28387097, 2.28709677,
    2.29032258, 2.29354839, 2.29677419, 2.3, 2.30322581, 2.30645161, 2.30967742, 2.31290323, 2.31612903, 2.31935484,
    2.32258065, 2.32580645, 2.32903226, 2.33225806, 2.33548387, 2.33870968, 2.34193548, 2.34516129, 2.3483871, 2.3516129,
    2.35483871, 2.35806452, 2.36129032, 2.36451613, 2.36774194, 2.37096774, 2.37419355, 2.37741935, 2.38064516, 2.38387097,
    2.38709677, 2.39032258, 2.39354839, 2.39677419, 2.4, 2.40322581, 2.40645161, 2.40967742, 2.41290323, 2.41612903,
    2.41935484, 2.42258065, 2.42580645, 2.42903226, 2.43225806, 2.43548387, 2.43870968, 2.44193548, 2.44516129, 2.4483871,
    2.4516129, 2.45483871, 2.45806452, 2.46129032, 2.46451613, 2.46774194, 2.47096774, 2.47419355, 2.47741935, 2.48064516,
    2.48387097, 2.48709677, 2.49032258, 2.49354839, 2.49677419, 2.5, 2.50322581, 2.50645161, 2.50967742, 2.51290323,
    2.51612903, 2.51935484, 2.52258065, 2.52580645, 2.52903226, 2.53225806, 2.53548387, 2.53870968, 2.54193548, 2.54516129,
    2.5483871, 2.5516129, 2.55483871, 2.55806452, 2.56129032, 2.56451613, 2.56774194, 2.57096774, 2.57419355, 2.57741935,
    2.58064516, 2.58387097, 2.58709677, 2.59032258, 2.59354839, 2.59677419, 2.6, 2.60322581, 2.60645161, 2.60967742,
    2.61290323, 2.61612903, 2.61935484, 2.62258065, 2.62580645, 2.62903226, 2.63225806, 2.63548387, 2.63870968, 2.64193548,
    2.64516129, 2.6483871, 2.6516129, 2.65483871, 2.65806452, 2.66129032, 2.66451613, 2.66774194, 2.67096774, 2.67419355,
    2.67741935, 2.68064516, 2.68387097, 2.68709677, 2.69032258, 2.69354839, 2.69677419, 2.7, 2.70322581, 2.70645161,
    2.70967742, 2.71290323, 2.71612903, 2.71935484, 2.72258065, 2.72580645, 2.72903226, 2.73225806, 2.73548387, 2.73870968,
    2.74193548, 2.74516129, 2.7483871, 2.7516129, 2.75483871, 2.75806452, 2.76129032, 2.76451613, 2.76774194, 2.77096774,
    2.77419355, 2.77741935, 2.78064516, 2.78387097, 2.78709677, 2.79032258, 2.79354839, 2.79677419, 2.8, 2.80322581,
    2.80645161, 2.80967742, 2.81290323, 2.81612903, 2.81935484, 2.82258065, 2.82580645, 2.82903226, 2.83225806, 2.83548387,
    2.83870968, 2.84193548, 2.84516129, 2.8483871, 2.8516129, 2.85483871, 2.85806452, 2.86129032, 2.86451613, 2.86774194,
    2.87096774, 2.87419355, 2.87741935, 2.88064516, 2.88387097, 2.88709677, 2.89032258, 2.89354839, 2.89677419, 2.9,
    2.90322581, 2.90645161, 2.90967742, 2.91290323, 2.91612903, 2.91935484, 2.92258065, 2.92580645, 2.92903226, 2.93225806,
    2.93548387, 2.93870968, 2.94193548, 2.94516129, 2.9483871, 2.9516129, 2.95483871, 2.95806452, 2.96129032, 2.96451613,
    2.96774194, 2.97096774, 2.97419355, 2.97741935, 2.98064516, 2.98387097, 2.98709677, 2.99032258, 2.99354839, 2.99677419,
    3.0, 3.00322581, 3.00645161, 3.00967742, 3.01290323, 3.01612903, 3.01935484, 3.02258065, 3.02580645, 3.02903226,
    3.03225806, 3.03548387, 3.03870968, 3.04193548, 3.04516129, 3.0483871, 3.0516129, 3.05483871, 3.05806452, 3.06129032,
    3.06451613, 3.06774194, 3.07096774, 3.07419355, 3.07741935, 3.08064516, 3.08387097, 3.08709677, 3.09032258, 3.09354839,
    3.09677419, 3.1, 3.10322581, 3.10645161, 3.10967742, 3.11290323, 3.11612903, 3.11935484, 3.12258065, 3.12580645,
    3.12903226, 3.13225806, 3.13548387, 3.13870968, 3.14193548, 3.14516129, 3.1483871, 3.1516129, 3.15483871, 3.15806452,
    3.16129032, 3.16451613, 3.16774194, 3.17096774, 3.17419355, 3.17741935, 3.18064516, 3.18387097, 3.18709677, 3.19032258,
    3.19354839, 3.19677419, 3.2, 3.20322581, 3.20645161, 3.20967742, 3.21290323, 3.21612903, 3.21935484, 3.22258065,
    3.22580645, 3.22903226, 3.23225806, 3.23548387, 3.23870968, 3.24193548, 3.24516129, 3.2483871, 3.2516129, 3.25483871,
    3.25806452, 3.26129032, 3.26451613, 3.26774194, 3.27096774, 3.27419355, 3.27741935, 3.28064516, 3.28387097, 3.28709677,
    3.29032258, 3.29354839, 3.29677419, 3.3]

NOM_RES = 10000
SER_RES = 10000
TEMP_NOM = 25
NUM_SAMPLES = 25
THERM_B_COEFF = 3950
ADC_MAX = 1023
ADC_Vmax = 3.3

def init_temp_sensor(TENP_SENS_ADC_PIN_NO = 36):
    adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
    adc.atten(ADC.ATTN_11DB)
    adc.width(ADC.WIDTH_10BIT)
    return adc

def read_temp(temp_sens):
    raw_read = []
    # Collect NUM_SAMPLES
    for i in range(1, NUM_SAMPLES+1):
        raw_read.append(temp_sens.read())

    # Average of the NUM_SAMPLES and look it up in the table
    raw_average = sum(raw_read)/NUM_SAMPLES
    #print('raw_avg = ' + str(raw_average))
    #print('V_measured = ' + str(adc_V_lookup[round(raw_average)]))

    # Convert to resistance
    raw_average = ADC_MAX * adc_V_lookup[round(raw_average)]/ADC_Vmax
    resistance = (SER_RES * raw_average) / (ADC_MAX - raw_average)
    #print('Thermistor resistance: {} ohms'.format(resistance))

    # Convert to temperature
    steinhart  = log(resistance / NOM_RES) / THERM_B_COEFF
    steinhart += 1.0 / (TEMP_NOM + 273.15)
    steinhart  = (1.0 / steinhart) - 273.15
    return steinhart

#print("I'm alive!\n")
#utime.sleep_ms(2000)

#temp_sens = init_temp_sensor()

#sample_last_ms = 0
#SAMPLE_INTERVAL = 1000

#while (True):
#    if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
#        temp = read_temp(temp_sens)
#        print('Thermistor temperature: ' + str(temp))
#        sample_last_ms = utime.ticks_ms()
